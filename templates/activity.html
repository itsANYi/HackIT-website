{% extends "base.html" %}

{% block title %}ç¤¾åœ˜æ´»å‹• - é»‘å®¢ITç¤¾{% endblock %}

{% block content %}
<div class="activity-container">
    <div id="lobby" class="activity-card glass-effect">
        <h1 class="activity-title">ğŸ® ç ´å†°å•ç­”éŠæˆ²</h1>
        <p class="activity-description">
            éš¨æ©Ÿé…å°ä¸€ä½ç¤¾å“¡ï¼Œé€éä¸€å•ä¸€ç­”çš„æ–¹å¼äº’ç›¸èªè­˜ï¼<br>
            æ¯è¼ªåªèƒ½å•å°æ–¹ä¸€å€‹å•é¡Œï¼Œç­‰å¾…å°æ–¹å›ç­”å¾Œæ‰èƒ½é€²è¡Œä¸‹ä¸€è¼ªã€‚
        </p>
        
        <div class="game-rules">
            <h3>éŠæˆ²è¦å‰‡ï¼š</h3>
            <ul>
                <li>ğŸ¯ ç³»çµ±æœƒéš¨æ©Ÿå¹«ä½ é…å°ä¸€ä½ç¤¾å“¡</li>
                <li>ğŸ’¬ æ¯è¼ªä½ å¯ä»¥å•å°æ–¹ä¸€å€‹å•é¡Œæˆ–å›ç­”å°æ–¹çš„å•é¡Œ</li>
                <li>â­ï¸ é›™æ–¹éƒ½å›ç­”å¾Œï¼Œé»æ“Šã€Œä¸‹ä¸€è¼ªã€ç¹¼çºŒéŠæˆ²</li>
                <li>ğŸ æƒ³çµæŸæ™‚é»æ“Šã€ŒéŠæˆ²çµæŸã€</li>
            </ul>
        </div>
        
        <button id="start-game" onclick="findMatch()" class="btn-primary btn-large">
            é–‹å§‹å°‹æ‰¾é…å°
        </button>
        
        <div id="waiting" class="waiting-message" style="display: none;">
            <div class="spinner"></div>
            <p>æ­£åœ¨å°‹æ‰¾é…å°å°è±¡...</p>
        </div>
    </div>
    
    <div id="game-room" class="activity-card glass-effect" style="display: none;">
        <div class="game-header">
            <h2>ğŸ® éŠæˆ²é€²è¡Œä¸­</h2>
            <div class="game-info">
                <p>é…å°å°è±¡: <strong id="partner-name"></strong></p>
                <p>ç•¶å‰è¼ªæ¬¡: <strong id="current-round">1</strong></p>
            </div>
        </div>
        
        <div class="chat-container">
            <div id="messages" class="messages-box"></div>
        </div>
        
        <div class="input-container">
            <input type="text" id="message-input" class="input-field" placeholder="è¼¸å…¥ä½ çš„å•é¡Œæˆ–å›ç­”..." onkeypress="handleKeyPress(event)">
            <button id="question-btn" onclick="sendMessage('question')" class="btn-primary">â“ æå•</button>
            <button id="answer-btn" onclick="sendMessage('answer')" class="btn-primary">ğŸ’¬ å›ç­”</button>
        </div>
        
        <div class="game-controls">
            <button onclick="nextRound()" class="btn-secondary">â­ï¸ ä¸‹ä¸€è¼ª</button>
            <button onclick="endGame()" class="btn-danger">ğŸ éŠæˆ²çµæŸ</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let socket;
let currentRoom = null;
let playerRole = null;
let localRoundState = {
    askedThisRound: false,
    answeredThisRound: false,
    roundComplete: false,
    readyForNext: false
};

document.addEventListener('DOMContentLoaded', function() {
    console.log('[v0] Page loaded, initializing socket...');
    
    if (typeof io === 'undefined') {
        console.error('[v0] Socket.IO library not loaded!');
        alert('Socket.IO æœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
        return;
    }
    
    socket = io();
    
    socket.on('connect', () => {
        console.log('[v0] Socket connected successfully, ID:', socket.id);
    });
    
    socket.on('disconnect', () => {
        console.log('[v0] Socket disconnected');
    });
    
    socket.on('error', (data) => {
        console.error('[v0] Socket error:', data);
        alert(data.message || 'ç™¼ç”ŸéŒ¯èª¤');
    });
    
    socket.on('waiting', (data) => {
        console.log('[v0] Waiting for match:', data.message);
        document.getElementById('start-game').style.display = 'none';
        document.getElementById('waiting').style.display = 'block';
    });

    socket.on('match_found', (data) => {
        console.log('[v0] Match found:', data);
        currentRoom = data.room_id;
        playerRole = data.you_are;
        
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-room').style.display = 'block';
        document.getElementById('partner-name').textContent = data.partner;
        
        addSystemMessage(`âœ¨ é…å°æˆåŠŸï¼ä½ çš„å°æ‰‹æ˜¯ ${data.partner}`);
        addSystemMessage('ğŸ’¡ é–‹å§‹äº’ç›¸æå•å§ï¼æ¯è¼ªä½ éœ€è¦æå•ä¸€æ¬¡ä¸¦å›ç­”å°æ–¹ä¸€æ¬¡ã€‚');
        
        resetLocalState();
        updateUI();
    });

    socket.on('receive_message', (data) => {
        addMessage(data.from, data.message, false, data.type);
    });
    
    socket.on('message_blocked', (data) => {
        alert(data.message);
    });
    
    socket.on('round_complete', (data) => {
        localRoundState.roundComplete = true;
        addSystemMessage('ğŸ‰ ' + data.message);
        updateUI();
    });
    
    socket.on('player_ready', (data) => {
        addSystemMessage(`â³ ${data.player} å·²æº–å‚™å¥½é€²å…¥ä¸‹ä¸€è¼ª`);
    });

    socket.on('round_updated', (data) => {
        document.getElementById('current-round').textContent = data.round;
        addSystemMessage(`ğŸ¯ é€²å…¥ç¬¬ ${data.round} è¼ª`);
        resetLocalState();
        updateUI();
    });

    socket.on('game_ended', (data) => {
        addSystemMessage('ğŸ ' + data.message);
        setTimeout(() => {
            location.reload();
        }, 2000);
    });
});

function resetLocalState() {
    localRoundState = {
        askedThisRound: false,
        answeredThisRound: false,
        roundComplete: false,
        readyForNext: false
    };
}

function sendMessage(type) {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message || !currentRoom || !socket) return;
    
    // æª¢æŸ¥æ˜¯å¦å¯ä»¥ç™¼é€
    if (type === 'question' && localRoundState.askedThisRound) {
        alert('æœ¬è¼ªä½ å·²ç¶“æå•éäº†ï¼');
        return;
    }
    if (type === 'answer' && localRoundState.answeredThisRound) {
        alert('æœ¬è¼ªä½ å·²ç¶“å›ç­”éäº†ï¼');
        return;
    }
    
    socket.emit('send_message', {
        room_id: currentRoom,
        message: message,
        type: type
    });
    
    // æ›´æ–°æœ¬åœ°ç‹€æ…‹
    if (type === 'question') {
        localRoundState.askedThisRound = true;
        addMessage('ä½ ', message, true, 'question');
    } else {
        localRoundState.answeredThisRound = true;
        addMessage('ä½ ', message, true, 'answer');
    }
    
    input.value = '';
    updateUI();
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        // é è¨­ç™¼é€å•é¡Œï¼Œé™¤éå·²ç¶“å•éäº†å°±ç™¼é€å›ç­”
        const type = localRoundState.askedThisRound ? 'answer' : 'question';
        sendMessage(type);
    }
}

function addMessage(sender, message, isMe, type) {
    const messagesBox = document.getElementById('messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isMe ? 'message-sent' : 'message-received'}`;
    
    const typeLabel = type === 'question' ? 'â“ æå•' : 'ğŸ’¬ å›ç­”';
    
    messageDiv.innerHTML = `
        <div class="message-sender">${sender} <span class="message-type">${typeLabel}</span></div>
        <div class="message-content">${message}</div>
    `;
    messagesBox.appendChild(messageDiv);
    messagesBox.scrollTop = messagesBox.scrollHeight;
}

function addSystemMessage(message) {
    const messagesBox = document.getElementById('messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message message-system';
    messageDiv.textContent = message;
    messagesBox.appendChild(messageDiv);
    messagesBox.scrollTop = messagesBox.scrollHeight;
}

function updateUI() {
    const input = document.getElementById('message-input');
    const questionBtn = document.getElementById('question-btn');
    const answerBtn = document.getElementById('answer-btn');
    const nextBtn = document.querySelector('.game-controls button:first-child');
    
    // å¦‚æœè¼ªæ¬¡å®Œæˆï¼Œç¦ç”¨è¼¸å…¥å’Œç™¼é€æŒ‰éˆ•
    if (localRoundState.roundComplete) {
        input.disabled = true;
        questionBtn.disabled = true;
        answerBtn.disabled = true;
        input.placeholder = 'ç­‰å¾…é›™æ–¹æŒ‰ä¸‹ã€Œä¸‹ä¸€è¼ªã€...';
    } else {
        input.disabled = false;
        questionBtn.disabled = localRoundState.askedThisRound;
        answerBtn.disabled = localRoundState.answeredThisRound;
        
        if (!localRoundState.askedThisRound) {
            input.placeholder = 'è¼¸å…¥ä½ çš„å•é¡Œ...';
        } else if (!localRoundState.answeredThisRound) {
            input.placeholder = 'å›ç­”å°æ–¹çš„å•é¡Œ...';
        }
    }
    
    // æ›´æ–°ä¸‹ä¸€è¼ªæŒ‰éˆ•ç‹€æ…‹
    if (localRoundState.readyForNext) {
        nextBtn.disabled = true;
        nextBtn.textContent = 'â³ ç­‰å¾…å°æ–¹...';
    } else if (localRoundState.roundComplete) {
        nextBtn.disabled = false;
        nextBtn.textContent = 'â­ï¸ ä¸‹ä¸€è¼ª';
    } else {
        nextBtn.disabled = true;
        nextBtn.textContent = 'â­ï¸ ä¸‹ä¸€è¼ªï¼ˆå°šæœªå®Œæˆï¼‰';
    }
}

function nextRound() {
    if (!currentRoom || !socket || !localRoundState.roundComplete) return;
    
    localRoundState.readyForNext = true;
    socket.emit('next_round', { room_id: currentRoom });
    updateUI();
}

function endGame() {
    if (!currentRoom || !socket) return;
    if (confirm('ç¢ºå®šè¦çµæŸéŠæˆ²å—ï¼Ÿ')) {
        socket.emit('end_game', { room_id: currentRoom });
    }
}

function findMatch() {
    console.log('[v0] findMatch called');
    
    if (!socket) {
        console.error('[v0] Socket not initialized');
        alert('é€£æ¥æœªå»ºç«‹ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
        return;
    }
    
    if (!socket.connected) {
        console.error('[v0] Socket not connected');
        alert('ä¼ºæœå™¨æœªé€£æ¥ï¼Œè«‹ç¨å¾Œå†è©¦');
        return;
    }
    
    console.log('[v0] Emitting find_match event');
    socket.emit('find_match');
    
    document.getElementById('start-game').style.display = 'none';
    document.getElementById('waiting').style.display = 'block';
}
</script>
{% endblock %}
